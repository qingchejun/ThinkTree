# ThinkTree 开发任务清单

## 📋 项目概述

ThinkTree - AI 驱动的思维导图生成工具，对标 Mapify.so  
**当前版本**: v2.0.0 🔥 **用户认证系统开发中**

## 🎯 Phase 1 - 核心功能 ✅ 已完成

### ✅ 项目基础架构

- [x] 创建 Next.js 14 前端项目 (App Router)
- [x] 创建 FastAPI 后端项目
- [x] 配置 Tailwind CSS 3
- [x] 设置项目目录结构
- [x] 环境变量配置和管理

### ✅ 后端开发

- [x] FastAPI 主应用框架搭建
- [x] Google Gemini AI 集成和配置
- [x] 文件解析模块 (TXT, MD, DOCX, PDF, SRT)
- [x] API 路由设计 (`/api/process-text`, `/api/upload`)
- [x] 错误处理和日志系统
- [x] CORS 配置和跨域处理
- [x] **Markdown 格式数据生成** (替代 JSON)
- [x] **修复 API 响应格式** (`data` 字段统一)
- [x] **AI Prompt 优化** (知识架构师模板，无损信息提取)

### ✅ 前端开发

- [x] Next.js App Router 页面配置
- [x] 主页设计和实现 (`/`)
- [x] 思维导图生成测试页面 (`/test`)
- [x] **Markmap 完整集成** (markmap-view + markmap-lib)
- [x] API 集成和数据处理
- [x] 响应式设计和移动端适配
- [x] **路由问题修复** (404 错误解决)

### ✅ 思维导图功能

- [x] AI 文本解析和结构化处理
- [x] **Markmap 思维导图渲染** (替代 ReactFlow)
- [x] **markmap-lib 数据转换** (Markdown → 思维导图)
- [x] **markmap-view 可视化** (完整连线和节点)
- [x] 实时生成和预览功能
- [x] **自适应窗口大小** (ResizeObserver + 手动适应)
- [x] **交互功能** (缩放、拖拽、平移)

## 🚀 Phase 2 - 文档上传功能 ✅ v1.1.0 已完成

### ✅ 文档上传功能实现

- [x] **PDF 文件上传和解析**
  - [x] 前端文件选择组件 (FileUpload.jsx)
  - [x] 后端 PDF 解析集成 (现有 API)
  - [x] 文件大小和格式验证
  - [x] PyMuPDF 依赖添加 (性能优化)
- [x] **多格式文件支持**
  - [x] TXT 文件上传和处理
  - [x] SRT 字幕文件支持
  - [x] Word 文档解析 (DOCX)
  - [x] Markdown 文件处理
- [x] **上传体验优化**
  - [x] 拖拽上传界面设计
  - [x] 双模式切换 (文件上传/文本输入)
  - [x] 文件信息展示和处理状态
  - [x] 错误提示和重试机制
  - [x] **界面简化** (移除多格式选择，专注核心功能)

### ✅ v1.1.0 核心成就

- [x] **完整文件上传流程**: 从前端组件到后端 API 处理
- [x] **AI 处理优化**: 知识架构师模板，零信息损失
- [x] **用户体验提升**: 拖拽上传、实时反馈、状态管理
- [x] **性能优化**: PyMuPDF 集成，PDF 解析速度提升 3-5 倍
- [x] **界面简化**: 移除复杂选项，专注核心功能

## 🌐 Phase 3 - 云端部署 ✅ v1.2.0 已完成

### ✅ Render 云平台部署

- [x] **后端部署成功**
  - [x] FastAPI 应用部署到 Render
  - [x] 环境变量配置 (GEMINI_API_KEY)
  - [x] 生产环境优化 (gunicorn, 端口配置)
  - [x] 健康检查接口正常运行
- [x] **前端部署成功**
  - [x] Next.js 应用部署到 Render
  - [x] 环境变量配置 (NEXT_PUBLIC_API_URL)
  - [x] 静态资源构建和优化
  - [x] 前后端通信正常
- [x] **CORS 和网络配置**
  - [x] 后端 CORS 域名白名单配置
  - [x] API 地址环境变量化
  - [x] 跨域请求处理优化
- [x] **生产环境验证**
  - [x] 文件上传功能测试通过
  - [x] AI 思维导图生成功能正常
  - [x] 前后端通信稳定

### ✅ v1.2.0 部署架构

```
前端: https://thinktree-frontend.onrender.com
后端: https://thinktree-backend.onrender.com
区域: Singapore (Southeast Asia)
状态: 🟢 正常运行
```

### ✅ v1.2.0 核心成就

- [x] **云端完整部署**: 前后端全部署在 Render，稳定运行
- [x] **生产环境优化**: 依赖管理、环境变量、CORS 配置
- [x] **全功能验证**: 文档上传、AI 处理、思维导图生成全链路通过
- [x] **用户可访问**: 提供公网访问地址，无需本地环境

## 👤 Phase 4 - 用户认证系统 🔥 v2.0.0 开发中

### ✅ 后端认证系统

- [x] **数据库架构**
  - [x] PostgreSQL 数据库部署 (Render)
  - [x] SQLAlchemy ORM 配置
  - [x] User 数据模型 (id, email, password_hash, 时间戳等)
  - [x] 数据库连接和会话管理
  - [x] 自动建表机制
- [x] **安全工具**
  - [x] bcrypt 密码哈希加密
  - [x] JWT 令牌生成和验证
  - [x] 邮箱格式验证
  - [x] 密码强度验证
  - [x] 令牌解析和用户 ID 提取
- [x] **认证 API**
  - [x] `POST /api/auth/register` - 用户注册
  - [x] `POST /api/auth/login` - 用户登录
  - [x] `GET /api/auth/profile` - 获取用户信息
  - [x] `GET /api/auth/verify-token` - 验证令牌
  - [x] JWT Bearer Token 认证中间件
  - [x] Pydantic 请求/响应模型

### ✅ 前端认证系统

- [x] **认证页面**
  - [x] 创建 `/login` 登录页面 (完整表单设计)
  - [x] 创建 `/register` 注册页面 (注册表单+确认密码)
  - [x] 表单设计和验证 (前端验证+后端API集成)
  - [x] 用户友好的错误提示 (实时错误显示+成功提示)
  - [x] 响应式设计 (移动端适配+现代化UI)
- [x] **状态管理**
  - [x] JWT 令牌安全存储 (localStorage)
  - [x] 登录状态管理 (React useState)
  - [x] 表单状态验证和处理
  - [x] 加载状态和错误状态管理
- [x] **API 集成**
  - [x] POST /api/auth/login 接口集成
  - [x] POST /api/auth/register 接口集成
  - [x] 环境变量配置 (开发/生产环境)
  - [x] 错误处理和网络异常处理
- [x] **部署配置**
  - [x] 生产环境变量配置 (.env.production)
  - [x] Render 平台自动部署
  - [x] 前后端API通信验证
- [ ] **待完善功能**
  - [ ] 全局用户状态管理 (React Context)
  - [ ] 导航栏用户菜单集成
  - [ ] 私有路由保护中间件
  - [ ] 自动令牌刷新机制

### 🔄 数据持久化 (计划中)

- [ ] **思维导图管理**
  - [ ] 保存用户生成的思维导图
  - [ ] 思维导图列表和分类
  - [ ] 编辑和删除功能
  - [ ] 思维导图版本历史
- [ ] **用户偏好**
  - [ ] 个人设置和偏好存储
  - [ ] 默认思维导图样式
  - [ ] 文件上传偏好设置

### 🚀 v2.0.0 目标架构

```
用户认证流程:
注册/登录 → JWT令牌 → 受保护的API → 个人数据持久化

技术栈升级:
- 后端: FastAPI + PostgreSQL + JWT + bcrypt
- 前端: Next.js + React Context + 认证中间件
- 部署: Render 云端数据库 + 环境变量管理
```

## 🎨 Phase 5 - 功能增强 (v3.0.0 规划)

### 🔄 思维导图增强

- [ ] **样式和主题**
  - [ ] 多种思维导图主题
  - [ ] 自定义颜色方案
  - [ ] 节点样式定制
- [ ] **编辑功能**
  - [ ] 节点内容编辑
  - [ ] 手动添加/删除节点
  - [ ] 拖拽调整布局
- [ ] **导出功能**
  - [ ] PNG/JPG 图片导出
  - [ ] PDF 文档导出
  - [ ] SVG 矢量导出
  - [ ] 高分辨率选项

### 🔄 协作和分享

- [ ] **分享功能**
  - [ ] 分享链接生成
  - [ ] 公开/私有权限控制
  - [ ] 分享页面优化
- [ ] **协作功能** (高级)
  - [ ] 实时协作编辑
  - [ ] 评论系统
  - [ ] 版本历史
  - [ ] 团队工作区

### 🔄 高级功能

- [ ] **多语言支持**
  - [ ] 中英文界面切换
  - [ ] 多语言文档处理
- [ ] **AI 能力扩展**
  - [ ] 思维导图样式建议
  - [ ] 内容摘要生成
  - [ ] 关键词提取优化
- [ ] **企业级功能**
  - [ ] 团队工作区
  - [ ] 数据导入/导出
  - [ ] API 接口开放

## 🔧 技术架构总结

### 当前技术栈 (v2.0.0)

```
前端: Next.js 14 + React 18 + Tailwind CSS 3
思维导图: markmap-view + markmap-lib + D3.js
后端: FastAPI + Python 3.11 + PostgreSQL
认证: JWT + bcrypt + SQLAlchemy ORM
AI引擎: Google Gemini API
文档解析: PyMuPDF + pdfplumber + python-docx
部署: Render Cloud Platform (Singapore)
```

### 核心数据流

```
用户注册/登录 → JWT令牌生成 → 认证中间件验证 →
文件上传/文本输入 → FastAPI后端 → 文件解析器 → Google Gemini AI →
Markdown格式数据 → markmap-lib转换 → markmap-view渲染 →
用户数据持久化存储
```

### 关键组件

- **User Model (backend)**: SQLAlchemy 用户数据模型
- **Security Utils (backend)**: JWT 和密码加密工具
- **Auth API (backend)**: 完整的认证接口
- **FileUpload.jsx (frontend)**: 文件上传和文本输入组件
- **SimpleMarkmap.jsx (frontend)**: 思维导图渲染核心组件
- **ai_processor.py (backend)**: Google Gemini AI 处理器

## 📊 项目状态跟踪

### 当前版本: v2.0.0 🎉 **用户认证系统已完成**

- ✅ **后端认证完成**: 数据库、安全工具、API 接口全部就绪并部署
- ✅ **前端认证完成**: 登录/注册页面、API集成、生产部署成功
- ✅ **云端数据库**: PostgreSQL 部署成功，用户数据持久化就绪
- ✅ **全栈部署**: 前后端完整部署，认证功能在生产环境正常运行
- 🌐 **线上可用**: https://thinktree-frontend.onrender.com 用户认证功能可用

### v2.0.0 重大成就 🏆

**完成时间**: 2024-07-22  
**核心功能**:

- ✅ 完整的用户注册和登录功能 (前后端完整实现)
- ✅ JWT 认证和安全存储 (bcrypt + JWT + PostgreSQL)
- ✅ 现代化认证UI (响应式设计+用户体验优化)
- ✅ 生产环境部署 (Render 云平台+环境配置)
- ✅ API 集成和错误处理 (用户友好的交互体验)

### 下一个里程碑: v2.1.0 增强版

**预期完成时间**: 1-2 周内  
**主要目标**:

- 全局用户状态管理 (React Context)
- 私有路由保护和导航集成
- 思维导图个人化存储
- 用户控制台和个人设置

### 技术债务管理

- [ ] **测试覆盖** - 为认证系统添加单元测试
- [ ] **代码质量** - ESLint 规则完善和代码规范
- [ ] **性能监控** - 数据库查询优化和缓存策略
- [ ] **安全审计** - JWT 令牌安全性和密码策略

## 🐛 问题追踪和修复记录

### 已解决的关键问题 ✅

1. **Markmap 连线缺失** (2024-07-22)
   - 问题: 思维导图只显示节点，无连接线
   - 解决: 正确配置 markmap-view，添加 CSS 样式支持
2. **主页 404 错误** (2024-07-22)
   - 问题: localhost:3000 主页无法访问
   - 解决: 重启 Next.js 开发服务器，路由配置正常
3. **API 数据格式不匹配** (2024-07-22)
   - 问题: 后端返回`mindmap`字段，前端期望`data`字段
   - 解决: 统一 API 响应格式为`{success, data}`
4. **思维导图不适应窗口** (2024-07-22)
   - 问题: 窗口大小变化时思维导图不自动调整
   - 解决: 添加 ResizeObserver 监听和手动适应按钮
5. **端口冲突导致服务无法访问** (2024-07-22)
   - 问题: localhost:3000 反复无法访问，端口被占用
   - 解决: 创建一键启动脚本，自动清理冲突进程，提供多种解决方案
6. **Render 部署 AttributeError: Settings 属性名错误** (2024-07-22)
   - 问题: 后端部署失败，settings.GEMINI_API_KEY 不存在
   - 解决: 统一属性命名规范，大写改为小写下划线格式
   - 影响: ai_processor.py, upload.py 多个文件的属性引用修复
7. **前端认证页面生产环境部署** (2024-07-22)
   - 问题: 线上显示"功能开发中"，新开发的认证页面未部署
   - 解决: 创建 .env.production 配置，设置正确的后端API URL
   - 结果: 认证功能在生产环境正常运行
   - 问题: FileUpload.jsx 中硬编码 localhost:8000
   - 解决: 使用环境变量 `NEXT_PUBLIC_API_URL` 配置

### v2.0.0 开发中问题

8. **PostgreSQL 连接配置** (2024-07-22)
   - 问题: Render PostgreSQL URL 格式兼容性
   - 解决: 自动转换 `postgres://` 为 `postgresql://`
9. **数据库初始化** (2024-07-22)
   - 问题: 应用启动时自动创建数据表
   - 解决: FastAPI startup 事件调用 `create_tables()`

### 当前稳定状态 🟢

- **前端**: https://thinktree-frontend.onrender.com 正常运行
- **后端**: https://thinktree-backend.onrender.com (v2.0.0 部署中)
- **数据库**: PostgreSQL 云端数据库连接正常
- **AI 功能**: Google Gemini API 集成稳定
- **思维导图**: Markmap 渲染完全正常
- **文件上传**: 多格式文档处理功能完整
- **用户认证**: 后端 API 开发完成，等待部署测试

## 💡 开发经验总结

### 技术选择亮点

1. **Markmap 替代 ReactFlow** - 更专业的思维导图解决方案
2. **Markdown 数据格式** - 比 JSON 更适合思维导图结构
3. **Next.js App Router** - 现代化的 React 框架
4. **FastAPI 异步架构** - 高性能 Python 后端
5. **Render 云平台** - 简单可靠的部署解决方案
6. **PostgreSQL + SQLAlchemy** - 企业级数据库 + 成熟 ORM
7. **JWT + bcrypt** - 业界标准的认证和加密方案

### 关键学习点

- Markmap 需要正确的 CSS 和 JS 资源加载
- 前后端数据格式统一的重要性
- 自适应布局需要多重监听机制
- AI prompt 工程对结果质量的影响
- 云部署需要环境变量和 CORS 正确配置
- 数据库设计和 ORM 关系映射的重要性
- JWT 令牌安全存储和验证最佳实践

## 📝 最新更新记录

### 2024-07-22 v2.0.0 用户认证系统开发

1. **数据库架构完成**

   - ✅ **PostgreSQL 部署**: Render 云端数据库创建成功
   - ✅ **SQLAlchemy 配置**: 数据库连接和会话管理
   - ✅ **User 数据模型**: 完整的用户表结构和字段
   - ✅ **自动建表**: 应用启动时自动创建数据表

2. **安全系统实现**

   - ✅ **密码加密**: bcrypt 哈希算法
   - ✅ **JWT 令牌**: 生成、验证、解析完整流程
   - ✅ **数据验证**: 邮箱格式、密码强度验证
   - ✅ **安全工具**: 完整的认证和加密工具库

3. **认证 API 开发**

   - ✅ **用户注册**: 完整的注册流程和数据验证
   - ✅ **用户登录**: 凭证验证和令牌生成
   - ✅ **用户信息**: 获取当前用户资料
   - ✅ **令牌验证**: JWT 令牌有效性检查
   - ✅ **Pydantic 模型**: 类型安全的请求响应

4. **部署准备完成**
   - ✅ **依赖更新**: PostgreSQL 驱动、认证库、邮箱验证
   - ✅ **环境配置**: 数据库 URL、JWT 密钥环境变量
   - ✅ **版本升级**: FastAPI 应用版本升级到 v2.0.0
   - ✅ **代码推送**: GitHub 代码更新，准备 Render 部署

### v2.0.0 后端认证系统技术规格

**数据库层**:

```sql
-- User 表结构
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    is_verified BOOLEAN DEFAULT FALSE,
    display_name VARCHAR(100),
    avatar_url VARCHAR(500),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**API 接口**:

- `POST /api/auth/register` - 用户注册 (返回 JWT)
- `POST /api/auth/login` - 用户登录 (返回 JWT)
- `GET /api/auth/profile` - 获取用户信息 (需要 JWT)
- `GET /api/auth/verify-token` - 验证令牌 (需要 JWT)

**安全特性**:

- bcrypt 密码哈希 (自动盐值)
- JWT 令牌 (7 天有效期)
- 邮箱格式验证 (Pydantic EmailStr)
- 密码强度验证 (最少 8 位)
- SQL 注入防护 (SQLAlchemy ORM)

### 下阶段开发重点 🎯

1. **前端认证页面开发**: `/login` 和 `/register` 页面
2. **全局状态管理**: React Context + JWT 令牌存储
3. **路由保护**: 认证中间件和私有路由
4. **UI 集成**: 导航栏用户菜单和登录状态

---

**更新日期**: 2024-07-22  
**项目负责人**: ThinkTree 开发团队  
**项目状态**: 🔥 **v2.0.0 用户认证系统开发中 - 后端完成，前端开发中**  
**技术架构**: JWT 认证 + PostgreSQL + AI → Markdown → markmap  
**部署状态**: Render 云平台 + PostgreSQL 数据库稳定运行
