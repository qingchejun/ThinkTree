#!/bin/bash

# ThinkSo å®‰å…¨ç®¡ç†å‘˜åˆå§‹åŒ–è„šæœ¬æ¨¡æ¿
# 
# ä½¿ç”¨å‰è¯·ï¼š
# 1. å¤åˆ¶æ­¤æ–‡ä»¶ä¸º init_admin.sh
# 2. è®¾ç½®ç¯å¢ƒå˜é‡æˆ–ä¿®æ”¹ä¸‹æ–¹é…ç½®
# 3. è¿è¡Œ: chmod +x init_admin.sh && ./init_admin.sh
#
# ç¯å¢ƒå˜é‡è¯´æ˜ï¼š
# - ADMIN_EMAIL: ç®¡ç†å‘˜é‚®ç®± (é»˜è®¤: admin@example.com)
# - ADMIN_PASSWORD: ç®¡ç†å‘˜å¯†ç  (å¿…é¡»è®¾ç½®)
# - API_BASE_URL: APIåŸºç¡€URL (é»˜è®¤: https://thinktree-backend.onrender.com)
# - INVITATION_COUNT: åˆ›å»ºé‚€è¯·ç æ•°é‡ (é»˜è®¤: 5)

set -e  # å‡ºé”™æ—¶ç«‹å³é€€å‡º

# é¢œè‰²è¾“å‡ºå‡½æ•°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}[ä¿¡æ¯]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[æˆåŠŸ]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[è­¦å‘Š]${NC} $1"
}

log_error() {
    echo -e "${RED}[é”™è¯¯]${NC} $1"
}

# è·å–é…ç½®
get_config() {
    # ä»ç¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼è·å–é…ç½®
    API_BASE="${API_BASE_URL:-https://thinktree-backend.onrender.com}"
    ADMIN_EMAIL="${ADMIN_EMAIL:-admin@example.com}"
    INVITATION_COUNT="${INVITATION_COUNT:-5}"
    
    # å¯†ç å¿…é¡»é€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®æˆ–äº¤äº’å¼è¾“å…¥
    if [ -z "$ADMIN_PASSWORD" ]; then
        echo -n "è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç : "
        read -s ADMIN_PASSWORD
        echo
    fi
    
    if [ -z "$ADMIN_PASSWORD" ]; then
        log_error "ç®¡ç†å‘˜å¯†ç ä¸èƒ½ä¸ºç©º"
        exit 1
    fi
    
    log_info "é…ç½®ä¿¡æ¯:"
    log_info "  APIåœ°å€: $API_BASE"
    log_info "  ç®¡ç†å‘˜é‚®ç®±: $ADMIN_EMAIL"
    log_info "  é‚€è¯·ç æ•°é‡: $INVITATION_COUNT"
    echo
}

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    if ! command -v curl &> /dev/null; then
        log_error "curl å‘½ä»¤æœªæ‰¾åˆ°ï¼Œè¯·å…ˆå®‰è£… curl"
        exit 1
    fi
    
    if ! command -v jq &> /dev/null; then
        log_warning "å»ºè®®å®‰è£… jq ä»¥è·å¾—æ›´å¥½çš„JSONå¤„ç†ä½“éªŒ"
    fi
}

# å‘é€HTTPè¯·æ±‚çš„å®‰å…¨åŒ…è£…å‡½æ•°
safe_curl() {
    local method="$1"
    local url="$2"
    local data="$3"
    local headers="$4"
    
    if [ -n "$data" ]; then
        curl -s -w "\nHTTP_STATUS:%{http_code}" \
             -X "$method" \
             -H "Content-Type: application/json" \
             ${headers:+-H "$headers"} \
             -d "$data" \
             --connect-timeout 30 \
             --max-time 60 \
             "$url"
    else
        curl -s -w "\nHTTP_STATUS:%{http_code}" \
             -X "$method" \
             -H "Content-Type: application/json" \
             ${headers:+-H "$headers"} \
             --connect-timeout 30 \
             --max-time 60 \
             "$url"
    fi
}

# åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
create_admin_user() {
    log_info "æ­¥éª¤1ï¼šåˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·..."
    
    local admin_data=$(cat <<EOF
{
  "email": "$ADMIN_EMAIL",
  "password": "$ADMIN_PASSWORD",
  "invitation_code": "ADMIN_INIT",
  "display_name": "ThinkSo Admin"
}
EOF
)
    
    local response=$(safe_curl "POST" "$API_BASE/api/auth/register" "$admin_data")
    local http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
    local response_body=$(echo "$response" | sed '/HTTP_STATUS:/d')
    
    log_info "HTTPçŠ¶æ€ç : $http_status"
    
    if [ "$http_status" != "200" ]; then
        log_error "ç®¡ç†å‘˜ç”¨æˆ·åˆ›å»ºå¤±è´¥"
        log_error "å“åº”å†…å®¹: $response_body"
        log_warning "å¯èƒ½çš„åŸå› :"
        log_warning "1. é‚®ä»¶æœåŠ¡é…ç½®æœ‰é—®é¢˜"
        log_warning "2. åç«¯æ²¡æœ‰ ADMIN_INIT ç‰¹æ®Šé‚€è¯·ç æ”¯æŒ"
        log_warning "3. æ•°æ®åº“è¿æ¥é—®é¢˜"
        log_warning "4. ç®¡ç†å‘˜ç”¨æˆ·å·²å­˜åœ¨"
        return 1
    fi
    
    log_success "ç®¡ç†å‘˜ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼"
    return 0
}

# ç®¡ç†å‘˜ç™»å½•
login_admin() {
    log_info "æ­¥éª¤2ï¼šç®¡ç†å‘˜ç™»å½•..."
    
    local login_data=$(cat <<EOF
{
  "email": "$ADMIN_EMAIL",
  "password": "$ADMIN_PASSWORD"
}
EOF
)
    
    local response=$(safe_curl "POST" "$API_BASE/api/auth/login" "$login_data")
    local http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
    local response_body=$(echo "$response" | sed '/HTTP_STATUS:/d')
    
    if [ "$http_status" != "200" ]; then
        log_error "ç®¡ç†å‘˜ç™»å½•å¤±è´¥"
        log_error "å“åº”å†…å®¹: $response_body"
        return 1
    fi
    
    # æå–token (ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼)
    if command -v jq &> /dev/null; then
        TOKEN=$(echo "$response_body" | jq -r '.access_token // empty')
    else
        TOKEN=$(echo "$response_body" | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)
    fi
    
    if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
        log_error "æ— æ³•æå–è®¿é—®ä»¤ç‰Œ"
        log_error "ç™»å½•å“åº”: $response_body"
        return 1
    fi
    
    log_success "ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼"
    log_info "Token: ${TOKEN:0:20}..."
    return 0
}

# åˆ›å»ºé‚€è¯·ç 
create_invitation_codes() {
    log_info "æ­¥éª¤3ï¼šåˆ›å»ºé‚€è¯·ç ..."
    
    local codes=()
    local success_count=0
    
    for i in $(seq 1 $INVITATION_COUNT); do
        log_info "åˆ›å»ºé‚€è¯·ç  #$i..."
        
        local invitation_data=$(cat <<EOF
{
  "description": "ç®¡ç†å‘˜åˆ›å»ºçš„é‚€è¯·ç  #$i",
  "expires_at": null
}
EOF
)
        
        local response=$(safe_curl "POST" "$API_BASE/api/invitations/create" "$invitation_data" "Authorization: Bearer $TOKEN")
        local http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
        local response_body=$(echo "$response" | sed '/HTTP_STATUS:/d')
        
        if [ "$http_status" = "200" ]; then
            # æå–é‚€è¯·ç 
            if command -v jq &> /dev/null; then
                local invitation_code=$(echo "$response_body" | jq -r '.code // empty')
            else
                local invitation_code=$(echo "$response_body" | grep -o '"code":"[^"]*"' | cut -d'"' -f4)
            fi
            
            if [ -n "$invitation_code" ] && [ "$invitation_code" != "null" ]; then
                codes+=("$invitation_code")
                log_success "é‚€è¯·ç åˆ›å»ºæˆåŠŸ: $invitation_code"
                success_count=$((success_count + 1))
                
                # ä¿å­˜ç¬¬ä¸€ä¸ªé‚€è¯·ç ç”¨äºæµ‹è¯•
                if [ $i -eq 1 ]; then
                    FIRST_CODE="$invitation_code"
                fi
            else
                log_error "æ— æ³•ä»å“åº”ä¸­æå–é‚€è¯·ç "
            fi
        else
            log_error "é‚€è¯·ç åˆ›å»ºå¤±è´¥"
            log_error "å“åº”å†…å®¹: $response_body"
        fi
    done
    
    echo
    log_info "é‚€è¯·ç åˆ›å»ºå®Œæˆ: $success_count/$INVITATION_COUNT"
    
    # è¾“å‡ºæ‰€æœ‰åˆ›å»ºçš„é‚€è¯·ç 
    if [ ${#codes[@]} -gt 0 ]; then
        echo
        log_success "åˆ›å»ºçš„é‚€è¯·ç åˆ—è¡¨:"
        for i in "${!codes[@]}"; do
            echo "  $((i+1)). ${codes[$i]}"
        done
    fi
}

# ä¸»å‡½æ•°
main() {
    echo "=== ThinkSo å®‰å…¨ç®¡ç†å‘˜åˆå§‹åŒ–è„šæœ¬ ==="
    echo
    
    # æ£€æŸ¥ä¾èµ–
    check_dependencies
    
    # è·å–é…ç½®
    get_config
    
    # ç¡®è®¤æ‰§è¡Œ
    echo -n "ç¡®è®¤æ‰§è¡Œç®¡ç†å‘˜åˆå§‹åŒ–ï¼Ÿ(y/N): "
    read -r confirm
    if [[ ! "$confirm" =~ ^[Yy]([Ee][Ss])?$ ]]; then
        log_info "æ“ä½œå·²å–æ¶ˆ"
        exit 0
    fi
    echo
    
    # æ‰§è¡Œåˆå§‹åŒ–æ­¥éª¤
    if ! create_admin_user; then
        log_error "ç®¡ç†å‘˜ç”¨æˆ·åˆ›å»ºå¤±è´¥ï¼Œè„šæœ¬ç»ˆæ­¢"
        exit 1
    fi
    
    echo
    log_info "ç­‰å¾…5ç§’è®©æœåŠ¡å™¨å¤„ç†..."
    sleep 5
    
    if ! login_admin; then
        log_error "ç®¡ç†å‘˜ç™»å½•å¤±è´¥ï¼Œè„šæœ¬ç»ˆæ­¢"
        exit 1
    fi
    
    echo
    create_invitation_codes
    
    # è¾“å‡ºæœ€ç»ˆç»“æœ
    echo
    echo "=== åˆå§‹åŒ–å®Œæˆ ==="
    log_success "ç®¡ç†å‘˜é‚®ç®±: $ADMIN_EMAIL"
    
    if [ -n "$FIRST_CODE" ]; then
        echo
        # ä»API_BASEä¸­æ¨æ–­å‰ç«¯URL
        local frontend_url=$(echo "$API_BASE" | sed 's/backend/frontend/g' | sed 's/:8000//g')
        log_success "ğŸ‰ æµ‹è¯•æ³¨å†Œé“¾æ¥:"
        echo "   $frontend_url/register?invitation_code=$FIRST_CODE"
        echo
        log_info "æ‚¨ç°åœ¨å¯ä»¥ä½¿ç”¨è¿™ä¸ªé“¾æ¥æµ‹è¯•å®Œæ•´çš„æ³¨å†Œæµç¨‹äº†ï¼"
    fi
    
    echo
    log_info "ğŸ”— ç›¸å…³é“¾æ¥:"
    log_info "   å‰ç«¯åº”ç”¨: $(echo "$API_BASE" | sed 's/backend/frontend/g' | sed 's/:8000//g')"
    log_info "   åç«¯API: $API_BASE"
    log_info "   APIæ–‡æ¡£: $API_BASE/docs"
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"